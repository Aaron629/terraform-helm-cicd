name: CI/CD

on:
  pull_request:
    branches: [ main ]                     # åªæœ‰è¦åˆåˆ° main çš„ PR æ‰è·‘ CI
    paths: [ 'deploy/**', 'src/**', '.github/workflows/**' ]
  push:
    branches: [ main ]                     # åªæœ‰ main çš„ push æ‰è·‘ CD
    paths: [ 'deploy/**', 'src/**', '.github/workflows/**' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true                 # åŒä¸€åˆ†æ”¯å¤šæ¬¡æ¨é€æ™‚ï¼Œå–æ¶ˆèˆŠçš„ run

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform fmt
        run: terraform -chdir=deploy/terraform fmt -check -recursive
      - name: Helm lint
        run: helm lint charts/app   

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) èµ·ä¸€å€‹è‡¨æ™‚ KinD å¢é›†ï¼ˆæœƒè‡ªå‹•å¯«å¥½ ~/.kube/configï¼Œä¸¦è¨­å¥½ $KUBECONFIGï¼‰
      - name: Set up KinD (ephemeral k8s)
        uses: helm/kind-action@v1
        with:
          version: v0.23.0
          kubectl_version: v1.30.0
          cluster_name: kind   # ğŸ”‘ é€™æ¨£ context æœƒæ˜¯ kind-kind

      # 2) Debugï¼šç¢ºèª kubeconfig èˆ‡ context
      - name: Check kubeconfig & context
        run: |
          echo "KUBECONFIG=$KUBECONFIG"
          ls -la ~/.kube || true
          kubectl config get-contexts
          kubectl cluster-info

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (local backend)
        run: terraform -chdir=deploy/terraform init

      # 3) Applyï¼šæŠŠ KUBECONFIG èˆ‡ kind çš„ context å‚³çµ¦ TF
      - name: Terraform Apply
        run: |
          terraform -chdir=deploy/terraform apply -auto-approve \
            -var-file=envs/dev.tfvars \
            -var="kubeconfig_path=$KUBECONFIG" \
            -var="kube_context=kind-kind"

      # 4) Smoke test
      - name: Smoke Test
        run: |
          kubectl -n demo rollout status deploy/hello-app --timeout=120s || true
          kubectl -n demo get all

