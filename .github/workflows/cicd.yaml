name: CI/CD

on:
  pull_request:
    branches: [ main ]
    paths: [ 'deploy/**', 'src/**', '.github/workflows/**' ]
  push:
    branches: [ main ]
    paths: [ 'deploy/**', 'src/**', '.github/workflows/**' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform fmt
        run: terraform -chdir=deploy/terraform fmt -check -recursive
        
      - name: Terraform validate
        run: |
          terraform -chdir=deploy/terraform init -backend=false
          terraform -chdir=deploy/terraform validate
          
      - name: Helm lint
        run: helm lint charts/app

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) 建立 KinD 集群 - 使用穩定版本
      - name: Set up KinD cluster
        uses: helm/kind-action@v1.8.0
        with:
          version: v0.23.0
          kubectl_version: v1.30.0
          cluster_name: kind

      # 2) 驗證集群狀態和修正 kubeconfig 路徑
      - name: Verify cluster and fix kubeconfig path
        run: |
          echo "=== Environment Variables ==="
          echo "KUBECONFIG=$KUBECONFIG"
          echo "HOME=$HOME"
          
          echo "=== Fix kubeconfig path (expand tilde) ==="
          # 將 KUBECONFIG 路徑展開為絕對路徑
          EXPANDED_KUBECONFIG=$(eval echo $KUBECONFIG)
          echo "Original KUBECONFIG: $KUBECONFIG"
          echo "Expanded KUBECONFIG: $EXPANDED_KUBECONFIG"
          echo "KUBECONFIG=$EXPANDED_KUBECONFIG" >> $GITHUB_ENV
          
          echo "=== Kubeconfig file info ==="
          ls -la $EXPANDED_KUBECONFIG
          echo "File exists: $(test -f $EXPANDED_KUBECONFIG && echo 'YES' || echo 'NO')"
          echo "File readable: $(test -r $EXPANDED_KUBECONFIG && echo 'YES' || echo 'NO')"
          
          echo "=== Kubectl contexts ==="
          kubectl config get-contexts
          kubectl config current-context
          
          echo "=== Test connection to specific context ==="
          kubectl --context kind-kind cluster-info

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform -chdir=deploy/terraform init

      # 3) Terraform Plan 使用絕對路徑
      - name: Terraform Plan with Debug
        run: |
          CTX="$(kubectl config current-context)"
          # 將 KUBECONFIG 轉換為絕對路徑，避免波浪號問題
          KUBECONFIG_ABS=$(realpath $KUBECONFIG)
          echo "=== Terraform Debug Info ==="
          echo "Planning with context: $CTX"
          echo "Original KUBECONFIG: $KUBECONFIG"
          echo "Absolute KUBECONFIG: $KUBECONFIG_ABS"
          echo "Kubeconfig file exists: $(test -f $KUBECONFIG_ABS && echo 'YES' || echo 'NO')"
          
          echo "=== Testing kubectl with absolute path ==="
          kubectl --kubeconfig="$KUBECONFIG_ABS" --context="$CTX" get nodes
          
          echo "=== Running Terraform Plan ==="
          terraform -chdir=deploy/terraform plan \
            -var-file=envs/dev.tfvars \
            -var="kubeconfig_path=$KUBECONFIG_ABS" \
            -var="kube_context=${CTX}" \
            -detailed-exitcode || true

      # 4) Terraform Apply 使用絕對路徑
      - name: Terraform Apply
        run: |
          CTX="$(kubectl config current-context)"
          # 確保使用絕對路徑，不使用波浪號
          KUBECONFIG_ABS=$(realpath $KUBECONFIG)
          echo "Applying with context: $CTX"
          echo "Using absolute kubeconfig path: $KUBECONFIG_ABS"
          
          terraform -chdir=deploy/terraform apply -auto-approve \
            -var-file=envs/dev.tfvars \
            -var="kubeconfig_path=$KUBECONFIG_ABS" \
            -var="kube_context=${CTX}"

      # 5) 增強版的 Smoke Test
      - name: Smoke Test
        run: |
          echo "=== Checking namespace ==="
          kubectl get ns demo || echo "Namespace 'demo' not found"
          
          echo "=== Checking all resources in demo namespace ==="
          kubectl -n demo get all || echo "No resources in demo namespace"
          
          echo "=== Checking deployment status ==="
          if kubectl -n demo get deployment hello-app-app > /dev/null 2>&1; then
            echo "Deployment found, checking rollout status..."
            kubectl -n demo rollout status deploy/hello-app-app --timeout=120s
          else
            echo "Deployment 'hello-app-app' not found, listing all deployments:"
            kubectl -n demo get deployments
          fi
          
          echo "=== Checking pods ==="
          kubectl -n demo get pods
          
          echo "=== Checking services ==="
          kubectl -n demo get svc

      # 6) 可選：測試應用程式是否正常回應
      - name: Application Health Check
        run: |
          if kubectl -n demo get svc hello-app-app > /dev/null 2>&1; then
            echo "Service found, attempting port-forward test..."
            kubectl -n demo port-forward svc/hello-app-app 8080:80 &
            sleep 5
            curl -f http://localhost:8080 || echo "Health check failed, but continuing..."
            pkill -f "kubectl.*port-forward" || true
          else
            echo "Service not found, skipping health check"
            kubectl -n demo get svc
          fi