name: CI/CD

on:
  pull_request:
    branches: [ main ]                     # 只有要合到 main 的 PR 才跑 CI
    paths: [ 'deploy/**', 'src/**', '.github/workflows/**' ]
  push:
    branches: [ main ]                     # 只有 main 的 push 才跑 CD
    paths: [ 'deploy/**', 'src/**', '.github/workflows/**' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true                 # 同一分支多次推送時，取消舊的 run

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Terraform fmt
        run: terraform -chdir=deploy/terraform fmt -check -recursive
      - name: Helm lint
        run: helm lint charts/app   

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) 先建立 KinD 叢集，明確指定名稱（=> context 會叫 kind-kind）
      - name: Set up KinD (ephemeral k8s)
        uses: helm/kind-action@v1
        with:
          version: v0.23.0
          kubectl_version: v1.30.0
          cluster_name: kind

      # 2) Debug：確認 kubeconfig 路徑與 context 名稱（務必保留）
      - name: Check kube contexts
        run: |
          echo "KUBECONFIG=$KUBECONFIG"
          kubectl config get-contexts
          kubectl config current-context
          kubectl cluster-info

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (local state)
        run: terraform -chdir=deploy/terraform init

      # 3) 用「實際的 current-context」+ 正確的 KUBECONFIG 套用
      - name: Terraform Apply
        run: |
          CTX="$(kubectl config current-context)"
          echo "Using context: $CTX"
          terraform -chdir=deploy/terraform apply -auto-approve \
            -var-file=envs/dev.tfvars \
            -var="kubeconfig_path=$KUBECONFIG" \
            -var="kube_context=${CTX}"

      # 4) Smoke test
      - name: Smoke Test
        run: |
          kubectl -n demo get all
          kubectl -n demo rollout status deploy/hello-app-app --timeout=120s || true
